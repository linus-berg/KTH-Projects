import java.net.*;
import java.io.*;

public class HTTPAsk {
  public static void main( String[] args) throws IOException {
    ServerSocket srv = new ServerSocket(Integer.parseInt(args[0]));
    System.out.println("Accepting TCP connections on port: " + args[0]);
    Socket s = srv.accept();
    /* Loop and accept sockets! */
    while (true) {
      Thread tr = new Thread(new ConnectionHandle(s));
      tr.start();
      s = srv.accept();
    }
  }
}

class ConnectionHandle implements Runnable {
  private Socket socket = null;

  ConnectionHandle(Socket connection) throws IOException {
    this.socket = connection; 
    this.socket.setSoTimeout(1500);
  }

  public void run(){
    try {
      this.response();
    } catch (Exception E) {
      /* WELL I GUESS WE JUST CRASH AND BURN. */
    }
  }
  private String[] ParseArgs(StringBuilder request) throws IOException {
    String[] req = request.toString().split("\n");
    String host = req[1].split(" ")[1];
    String query = req[0].split(" ")[1];
    host = host.replaceAll("\\r", "");
    host = host.replaceAll("\\n", "");

    StringBuilder url_string = new StringBuilder();
    url_string.append("http://");
    url_string.append(host);
    url_string.append(url);
    URL url = new URL(url_string.toString());
    System.out.println(url.getQuery());
    String queries = url.getQuery();
    /* Hashmap of key and question. */
    Map<String, String> result = new HashMap<>();

    return new String[10];
  }

  private void response() throws IOException {
    /* Input buffer for the socket. */
    byte[] buffer_input = new byte[this.socket.getReceiveBufferSize()];
    int msg_size = 0;

    System.out.println("Request made by: " + this.socket.getInetAddress());
    /* Client input. */
    StringBuilder input_string = new StringBuilder();
    InputStream input_stream = this.socket.getInputStream();
    int buffer_reads = 0;
    while (msg_size != -1 && buffer_reads < 10) {
      try {
        /* Read, if server refuses to close catch timeout exception. */
        msg_size = input_stream.read(buffer_input);
        input_string.append(new String(buffer_input, 0, msg_size)); 
        buffer_reads++;
      } catch (Exception e) {
        /* Timed out, end read loop. */
        msg_size = -1;
      }
    }
    this.ParseArgs(input_string);
    this.socket.getOutputStream().write(input_string.toString().getBytes(), 0, input_string.length());
    this.socket.getOutputStream().write('\n');
    this.socket.close();
  }
}
